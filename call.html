<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>In Call</title>
    <link rel="stylesheet" href="style.css">
    <!-- REQUIRED FOR REAL NETWORKING -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
</head>
<body>

    <!-- GATEKEEPER -->
    <div id="gatekeeper" class="gatekeeper-overlay" style="display: none;">
        <div class="gatekeeper-card">
            <h1 id="gateIcon" style="font-size:40px; margin-bottom:10px;">üîí</h1>
            <h2 id="gateTitle">Locked</h2>
            <p id="gateDesc" style="color:#aaa; margin-bottom:20px;">Authentication Required</p>
            
            <div id="passEntryArea" style="display:none;">
                <input type="password" id="passInput" class="gatekeeper-input" placeholder="Enter Password">
                <button id="unlockBtn" class="btn-unlock">Enter Meeting</button>
                <p id="passError" class="error-msg">Incorrect Password</p>
            </div>

            <div id="timerArea" style="display:none;">
                <h1 id="countdown" style="font-size:32px; font-family:monospace;">00:00:00</h1>
            </div>
        </div>
    </div>

    <!-- LOADING -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <p id="loadingStatus">Initializing Connection...</p>
    </div>

    <!-- VIDEO GRID -->
    <div class="video-grid-container" id="videoGrid">
        <div class="video-tile local-stream">
            <video id="localVideo" autoplay muted playsinline></video>
            <div class="user-info">You</div>
        </div>
    </div>

    <!-- CONTROLS -->
    <div class="control-bar">
        <button id="toggleMicBtn" title="Microphone">üé§</button>
        <button id="toggleCamBtn" title="Camera">üìπ</button>
        <button id="shareScreenBtn" title="Share Screen">üñ•</button>
        <button id="chatBtn" title="Chat">üí¨</button>
        <button id="leaveBtn" title="Leave Call">‚ùå</button>
    </div>

    <!-- CHAT -->
    <div class="chat-sidebar" id="chatSidebar">
        <div class="chat-header"><h3>Chat</h3><button id="closeChatBtn">√ó</button></div>
        <div class="chat-messages" id="chatMessages"></div>
        <div class="chat-input-area">
            <input type="text" id="chatInput" placeholder="Message...">
            <button id="sendChatBtn">Send</button>
        </div>
    </div>

    <script src="ui.js"></script>
    <script src="rtc.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            // Use a unique prefix to ensure clean ID
            const roomId = "room-" + params.get('room');
            const auth = params.get('auth');
            const t = params.get('t');

            const gate = document.getElementById('gatekeeper');

            // 1. Check Time
            if (t) {
                const scheduled = parseInt(t);
                if (Date.now() < scheduled) {
                    gate.style.display = 'flex';
                    document.getElementById('gateIcon').innerText = "‚è≥";
                    document.getElementById('gateTitle').innerText = "Scheduled";
                    document.getElementById('gateDesc').innerText = "Please wait...";
                    document.getElementById('timerArea').style.display = 'block';
                    setInterval(() => {
                        const diff = scheduled - Date.now();
                        if (diff <= 0) location.reload();
                        const m = Math.floor((diff % (1000*60*60)) / (1000*60));
                        const s = Math.floor((diff % (1000*60)) / 1000);
                        document.getElementById('countdown').innerText = `${m}m ${s}s`;
                    }, 1000);
                    return;
                }
            }

            // 2. Check Password
            if (auth) {
                gate.style.display = 'flex';
                document.getElementById('passEntryArea').style.display = 'block';
                document.getElementById('unlockBtn').onclick = () => {
                    if (btoa(document.getElementById('passInput').value) === auth) {
                        gate.style.display = 'none';
                        startApp(roomId);
                    } else {
                        document.getElementById('passError').style.display = 'block';
                    }
                };
                return;
            }

            // 3. Start
            startApp(roomId);
        });

        async function startApp(roomId) {
            if (!roomId || roomId === "room-null") {
                alert("Invalid Link");
                window.location.href = "index.html";
                return;
            }

            // Initialize Media First
            await window.RTC.initMedia();
            
            // Remove Loading Screen
            document.getElementById('loadingOverlay').style.display = 'none';

            // Initialize Real Networking
            window.RTC.connectToRoom(roomId);
        }
    </script>
</body>
</html>
