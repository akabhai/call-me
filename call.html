<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>In Call</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <!-- 1. GATEKEEPER OVERLAY (Blocks view until verified) -->
    <div id="gatekeeper" class="gatekeeper-overlay" style="display: none;">
        <div class="gatekeeper-card">
            <div class="gatekeeper-icon" id="gateIcon">üîí</div>
            <h1 class="gatekeeper-title" id="gateTitle">Locked</h1>
            <p class="gatekeeper-desc" id="gateDesc">Verifying...</p>
            
            <!-- Password Input (Hidden by default) -->
            <div id="passEntryArea" style="display:none;">
                <input type="password" id="passInput" class="gatekeeper-input" placeholder="Enter Meeting Password">
                <button id="unlockBtn" class="btn-unlock">Join Meeting</button>
                <p id="passError" class="error-msg">Incorrect Password</p>
            </div>

            <!-- Timer Area (Hidden by default) -->
            <div id="timerArea" style="display:none;">
                <h2 id="countdown" style="font-size: 32px; margin: 20px 0;">00:00:00</h2>
            </div>
        </div>
    </div>

    <!-- 2. NORMAL CALL UI (Hidden behind Gatekeeper) -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <p id="loadingStatus">Initializing...</p>
    </div>

    <div class="video-grid-container" id="videoGrid">
        <div class="video-tile local-stream">
            <video id="localVideo" autoplay muted playsinline></video>
            <div class="user-info">You</div>
        </div>
    </div>

    <div class="control-bar">
        <button id="toggleMicBtn">üé§ Mute</button>
        <button id="toggleCamBtn">üìπ Off</button>
        <button id="shareScreenBtn">üñ• Share</button>
        <button id="chatBtn">üí¨ Chat</button>
        <button id="leaveBtn">‚ùå Leave</button>
    </div>

    <div class="chat-sidebar" id="chatSidebar">
        <div class="chat-header">
            <h3>Chat</h3>
            <button id="closeChatBtn">√ó</button>
        </div>
        <div class="chat-messages" id="chatMessages"></div>
        <div class="chat-input-area">
            <input type="text" id="chatInput" placeholder="Message...">
            <button id="sendChatBtn">Send</button>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script src="ui.js"></script>
    <script src="rtc.js"></script>
    
    <!-- INLINE SIGNALING TO HANDLE GATEKEEPER -->
    <script>
        // We moved the entry logic here to handle the Password/Time check
        document.addEventListener('DOMContentLoaded', async () => {
            const params = new URLSearchParams(window.location.search);
            const roomId = params.get('room');
            const auth = params.get('auth'); // Encoded password
            const time = params.get('t');    // Timestamp

            const gatekeeper = document.getElementById('gatekeeper');
            const gateTitle = document.getElementById('gateTitle');
            const gateDesc = document.getElementById('gateDesc');
            const gateIcon = document.getElementById('gateIcon');
            const passArea = document.getElementById('passEntryArea');
            const passInput = document.getElementById('passInput');
            const unlockBtn = document.getElementById('unlockBtn');
            const passError = document.getElementById('passError');
            const timerArea = document.getElementById('timerArea');
            const countdown = document.getElementById('countdown');

            // === CHECK 1: SCHEDULED TIME ===
            if (time) {
                const scheduledTime = parseInt(time);
                const now = Date.now();

                if (now < scheduledTime) {
                    gatekeeper.style.display = 'flex';
                    gateIcon.innerHTML = "‚è≥";
                    gateTitle.innerText = "Meeting Not Started";
                    gateDesc.innerText = "Please wait for the scheduled time.";
                    timerArea.style.display = 'block';
                    
                    // Countdown Logic
                    setInterval(() => {
                        const diff = scheduledTime - Date.now();
                        if (diff <= 0) {
                            location.reload(); // Reload to check password
                        }
                        const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                        const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                        countdown.innerText = `${hours}h ${minutes}m ${seconds}s`;
                    }, 1000);
                    return; // STOP HERE
                }
            }

            // === CHECK 2: PASSWORD ===
            if (auth) {
                gatekeeper.style.display = 'flex';
                gateIcon.innerHTML = "üîí";
                gateTitle.innerText = "Password Required";
                gateDesc.innerText = "This meeting is protected.";
                passArea.style.display = 'block';

                unlockBtn.onclick = () => {
                    // User input -> Encode to Base64 -> Compare with URL param
                    const userEntry = passInput.value;
                    const userEncoded = btoa(userEntry);

                    if (userEncoded === auth) {
                        // SUCCESS
                        gatekeeper.style.display = 'none';
                        startApp(roomId); // Proceed
                    } else {
                        passError.style.display = 'block';
                        passInput.style.border = "1px solid red";
                    }
                };
                return; // STOP HERE until unlocked
            }

            // === IF NO CHECKS FAIL, START APP ===
            startApp(roomId);
        });

        function startApp(roomId) {
            if (!roomId) {
                alert("No Room ID found! Redirecting...");
                window.location.href = 'index.html';
                return;
            }

            // Reconstruct Magnet for WebTorrent
            window.magnetURI = `magnet:?xt=urn:btih:${roomId}&dn=CallRoom&tr=wss://tracker.webtorrent.io`;

            // Call the external signaling logic
            // We load signaling.js dynamically or call its init function if it was wrapped
            // For simplicity, we assume signaling.js logic is compatible or we paste the simplified version here:
            initSignaling();
        }

        async function initSignaling() {
             const mediaSuccess = await window.RTC.initMedia();
             if (!mediaSuccess) return; 
             window.UI.showToast("Connected! Waiting for peers...");
             
             // Simulate connection for demo
             setTimeout(async () => {
                 const pc = window.RTC.createPeerConnection('peer-remote', false);
                 const ghostPC = new RTCPeerConnection();
                 ghostPC.createDataChannel("ghost");
                 const offer = await ghostPC.createOffer();
                 try {
                     await pc.setRemoteDescription(offer);
                     const answer = await pc.createAnswer();
                     await pc.setLocalDescription(answer);
                 } catch (e) {}
             }, 1500);
        }
    </script>
</body>
</html>
