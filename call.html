<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>In Call</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
</head>
<body>

    <!-- 1. GATEKEEPER (Password/Time) -->
    <div id="gatekeeper" class="gatekeeper-overlay" style="display: none;">
        <div class="gatekeeper-card">
            <h1 id="gateIcon" style="font-size:40px; margin-bottom:10px;">üîí</h1>
            <h2 id="gateTitle">Locked</h2>
            <p id="gateDesc" style="color:#aaa; margin-bottom:20px;">Authentication Required</p>
            
            <div id="passEntryArea" style="display:none;">
                <input type="password" id="passInput" class="gatekeeper-input" placeholder="Enter Password">
                <button id="unlockBtn" class="btn-unlock">Unlock</button>
                <p id="passError" class="error-msg">Incorrect Password</p>
            </div>

            <div id="timerArea" style="display:none;">
                <h1 id="countdown" style="font-size:32px;">00:00:00</h1>
            </div>
        </div>
    </div>

    <!-- 2. NEW: NAME ENTRY MODAL -->
    <div id="nameModal" class="gatekeeper-overlay" style="display: none; z-index: 2500;">
        <div class="name-entry-card">
            <h2>Join Meeting</h2>
            <p style="color:#666; font-size:14px; margin-bottom:10px;">Enter your display name</p>
            <input type="text" id="displayNameInput" class="name-input" placeholder="Your Name (e.g. John)">
            <button id="joinNameBtn" class="btn-unlock">Join Call</button>
        </div>
    </div>

    <!-- 3. LOADING -->
    <div class="loading-overlay" id="loadingOverlay" style="display:none;">
        <div class="loading-spinner"></div>
        <p id="loadingStatus">Initializing...</p>
    </div>

    <!-- VIDEO GRID -->
    <div class="video-grid-container" id="videoGrid">
        <div class="video-tile local-stream" id="localTile">
            <video id="localVideo" autoplay muted playsinline></video>
            <div class="user-info" id="localNameDisplay">You</div>
        </div>
    </div>

    <!-- CONTROLS -->
    <div class="control-bar">
        <button id="toggleMicBtn">üé§</button>
        <button id="toggleCamBtn">üìπ</button>
        <button id="shareScreenBtn">üñ•</button>
        <button id="pipBtn" title="Background Mode">üñºÔ∏è</button> <!-- NEW BUTTON -->
        <button id="chatBtn">üí¨</button>
        <button id="leaveBtn">‚ùå</button>
    </div>

    <!-- 6. CHAT -->
    <div class="chat-sidebar" id="chatSidebar">
        <div class="chat-header"><h3>Chat</h3><button id="closeChatBtn">√ó</button></div>
        <div class="chat-messages" id="chatMessages"></div>
        <div class="chat-input-area">
            <input type="text" id="chatInput" placeholder="Message...">
            <button id="sendChatBtn">Send</button>
        </div>
    </div>

     <script src="ui.js"></script>
    <script src="rtc.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const roomId = params.get('room');
            const auth = params.get('auth');
            const t = params.get('t');

            const gate = document.getElementById('gatekeeper');
            const nameModal = document.getElementById('nameModal');

            // STEP 1: Check Time
            if (t) {
                if (Date.now() < parseInt(t)) {
                    // ... (Keep existing timer logic)
                    gate.style.display = 'flex';
                    document.getElementById('gateIcon').innerText = "‚è≥";
                    document.getElementById('gateTitle').innerText = "Scheduled";
                    document.getElementById('gateDesc').innerText = "Please wait...";
                    document.getElementById('timerArea').style.display = 'block';
                    /* (Timer logic abbreviated for brevity, keep your existing timer code here) */
                    return; 
                }
            }

            // STEP 2: Check Password
            if (auth) {
                gate.style.display = 'flex';
                document.getElementById('passEntryArea').style.display = 'block';
                document.getElementById('unlockBtn').onclick = () => {
                    if (btoa(document.getElementById('passInput').value) === auth) {
                        gate.style.display = 'none';
                        showNameModal(roomId); // Proceed to Name
                    } else {
                        document.getElementById('passError').style.display = 'block';
                    }
                };
                return;
            }

            // STEP 3: No Security -> Show Name Modal directly
            showNameModal(roomId);
        });

        function showNameModal(roomId) {
            const modal = document.getElementById('nameModal');
            modal.style.display = 'flex';
            
            document.getElementById('joinNameBtn').onclick = () => {
                const name = document.getElementById('displayNameInput').value.trim() || "Guest";
                
                // Save Name to Global State
                if(!window.AppState) window.AppState = {};
                window.AppState.myName = name;
                
                // Update Local Display
                document.getElementById('localNameDisplay').innerText = name + " (You)";

                modal.style.display = 'none';
                document.getElementById('loadingOverlay').style.display = 'flex';
                
                // Start App
                startApp(roomId);
            };
        }

        async function startApp(roomId) {
            if (!roomId) return window.location.href = "index.html";
            // Initialize Media
            await window.RTC.initMedia();
            // Initialize Network
            // Clean ID
            const safeId = "room-" + roomId.replace(/[^a-zA-Z0-9_-]/g, '');
            window.RTC.connectToRoom(safeId);
        }
    </script>
</body>
</html>
